<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIForge - ç»Ÿè®¡åˆ†æ</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/modern.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold">APIForge</h1>
                <div class="flex gap-md">
                    <a href="/" class="nav-link">æ¦‚è§ˆ</a>
                    <a href="/monitor" class="nav-link">å®æ—¶ç›‘æ§</a>
                    <a href="/statistics" class="nav-link active">ç»Ÿè®¡åˆ†æ</a>
                    <a href="/errors" class="nav-link">é”™è¯¯æ—¥å¿—</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="container mt-4">
        <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
        <div class="card mb-4">
            <div class="flex justify-between items-center">
                <div class="select-group">
                    <label class="form-label mb-0">æ—¶é—´èŒƒå›´</label>
                    <div class="flex gap-sm" id="timeRangeButtons">
                        <button class="btn btn-sm btn-secondary active" data-hours="24">24å°æ—¶</button>
                        <button class="btn btn-sm btn-secondary" data-hours="168">7å¤©</button>
                        <button class="btn btn-sm btn-secondary" data-hours="720">30å¤©</button>
                        <button class="btn btn-sm btn-secondary" data-custom="true">è‡ªå®šä¹‰</button>
                    </div>
                    <div id="customDateRange" style="display: none;" class="flex items-center gap-sm ml-3">
                        <input type="datetime-local" id="startDate" class="form-input" style="width: 200px;">
                        <span class="text-muted">è‡³</span>
                        <input type="datetime-local" id="endDate" class="form-input" style="width: 200px;">
                        <button class="btn btn-sm btn-primary" onclick="applyCustomRange()">åº”ç”¨</button>
                    </div>
                </div>
                <div class="flex gap-sm">
                    <button class="btn btn-sm btn-primary" onclick="refreshStatistics()">
                        <span style="font-size: 1.1em;">â†»</span> åˆ·æ–°
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="exportStatistics()">
                        <span style="font-size: 0.9em;">ğŸ“Š</span> å¯¼å‡ºæŠ¥è¡¨
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¦‚è§ˆç»Ÿè®¡ -->
        <div class="grid grid-cols-4 mb-4">
            <div class="card stat-card">
                <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
                <div class="stat-value" id="totalTasks">-</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">æˆåŠŸç‡</div>
                <div class="stat-value" id="successRate">-</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">å¹³å‡è€—æ—¶</div>
                <div class="stat-value" id="avgDuration">-</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">é”™è¯¯ç‡</div>
                <div class="stat-value text-danger" id="errorRate">-</div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="grid grid-cols-2 gap-md mb-4">
            <!-- ä»»åŠ¡å®Œæˆè¶‹åŠ¿ -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ä»»åŠ¡å®Œæˆè¶‹åŠ¿</h2>
                </div>
                <div style="height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒ -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒ</h2>
                </div>
                <div style="height: 300px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- æ€§èƒ½åˆ†æ -->
        <div class="grid grid-cols-2 gap-md mb-4">
            <!-- å“åº”æ—¶é—´åˆ†å¸ƒ -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">å“åº”æ—¶é—´åˆ†å¸ƒ</h2>
                </div>
                <div style="height: 300px;">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>

            <!-- é‡è¯•æˆåŠŸç‡ -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">é‡è¯•æˆåŠŸç‡åˆ†æ</h2>
                </div>
                <div style="height: 300px;">
                    <canvas id="retryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ç«¯ç‚¹æ€§èƒ½æ’è¡Œ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ç«¯ç‚¹æ€§èƒ½æ’è¡Œ (TOP 10)</h2>
            </div>
            <div id="endpointPerformance">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ç«¯ç‚¹</th>
                            <th>è°ƒç”¨æ¬¡æ•°</th>
                            <th>æˆåŠŸç‡</th>
                            <th>å¹³å‡è€—æ—¶</th>
                            <th>æœ€å¤§è€—æ—¶</th>
                        </tr>
                    </thead>
                    <tbody id="endpointTableBody">
                        <tr>
                            <td colspan="5" class="text-center text-muted">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- å¼•å…¥è„šæœ¬ -->
    <script src="/static/js/api.js?v=1.0.4"></script>
    <script src="/static/js/utils-min.js?v=1.0.6"></script>
    <script src="/static/js/charts.js"></script>
    <script src="/static/lib/chart.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentTimeRange = 24; // é»˜è®¤24å°æ—¶
        let charts = {
            trend: null,
            status: null,
            responseTime: null,
            retry: null
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initTimeRangeButtons();
            initCharts();
            loadStatistics();
        });

        // åˆå§‹åŒ–æ—¶é—´èŒƒå›´æŒ‰é’®
        function initTimeRangeButtons() {
            const buttons = document.querySelectorAll('#timeRangeButtons button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    buttons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const customRange = document.getElementById('customDateRange');
                    if (this.dataset.custom) {
                        // æ˜¾ç¤ºè‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©
                        customRange.style.display = 'flex';
                        // è®¾ç½®é»˜è®¤å€¼
                        const now = new Date();
                        const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                        document.getElementById('startDate').value = yesterday.toISOString().slice(0, 16);
                        document.getElementById('endDate').value = now.toISOString().slice(0, 16);
                    } else {
                        // éšè—è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©
                        customRange.style.display = 'none';
                        currentTimeRange = parseInt(this.dataset.hours);
                        loadStatistics();
                    }
                });
            });
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // ä»»åŠ¡å®Œæˆè¶‹åŠ¿å›¾
            charts.trend = chartUtils.createTimelineChart(
                document.getElementById('trendChart').getContext('2d'),
                { labels: [], completed: [], failed: [] }
            );

            // ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒå›¾
            charts.status = chartUtils.createStatusChart(
                document.getElementById('statusChart').getContext('2d'),
                {}
            );

            // å“åº”æ—¶é—´åˆ†å¸ƒå›¾
            charts.responseTime = chartUtils.createResponseTimeChart(
                document.getElementById('responseTimeChart').getContext('2d'),
                []
            );

            // é‡è¯•æˆåŠŸç‡å›¾
            charts.retry = chartUtils.createRetryChart(
                document.getElementById('retryChart').getContext('2d'),
                []
            );
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatistics() {
            try {
                // æ„å»ºè¯·æ±‚å‚æ•°
                const params = { hours: currentTimeRange };
                
                // å¦‚æœæ˜¯è‡ªå®šä¹‰æ—¶é—´èŒƒå›´
                const customRange = document.getElementById('customDateRange');
                if (customRange.style.display !== 'none') {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate && endDate) {
                        params.start_date = new Date(startDate).toISOString();
                        params.end_date = new Date(endDate).toISOString();
                        delete params.hours;
                    }
                }

                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                const [hourlyStats, performanceStats, recentTasks] = await Promise.all([
                    api.getHourlyStatistics(params),
                    api.getPerformanceStatistics(params),
                    api.getRecentTasks({ ...params, limit: 1000 })
                ]);

                // æ›´æ–°æ¦‚è§ˆç»Ÿè®¡
                updateOverviewStats(hourlyStats.data, performanceStats);

                // æ›´æ–°å›¾è¡¨
                updateTrendChart(hourlyStats.data);
                updateStatusChart(performanceStats);
                updateResponseTimeChart(performanceStats.duration_distribution || []);
                updateRetryChart(performanceStats.retry_statistics || []);

                // æ›´æ–°ç«¯ç‚¹æ€§èƒ½è¡¨æ ¼
                updateEndpointPerformance(recentTasks.tasks);

            } catch (error) {
                console.error('Failed to load statistics:', error);
                utils.showError(document.querySelector('.container'), 'åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥');
            }
        }

        // æ›´æ–°æ¦‚è§ˆç»Ÿè®¡
        function updateOverviewStats(hourlyData, performanceData) {
            // è®¡ç®—æ€»ä»»åŠ¡æ•°
            const totalTasks = hourlyData.reduce((sum, item) => sum + (item.total || 0), 0);
            document.getElementById('totalTasks').textContent = utils.formatNumber(totalTasks);

            // è®¡ç®—æˆåŠŸç‡
            const completedTasks = hourlyData.reduce((sum, item) => sum + (item.completed || 0), 0);
            const successRate = totalTasks > 0 ? (completedTasks / totalTasks * 100) : 0;
            document.getElementById('successRate').textContent = utils.formatPercent(successRate);

            // å¹³å‡è€—æ—¶
            const avgDuration = performanceData.performance_by_status?.completed?.avg_duration || 0;
            document.getElementById('avgDuration').textContent = utils.formatDuration(avgDuration);

            // é”™è¯¯ç‡
            const failedTasks = hourlyData.reduce((sum, item) => sum + (item.failed || 0), 0);
            const errorRate = totalTasks > 0 ? (failedTasks / totalTasks * 100) : 0;
            document.getElementById('errorRate').textContent = utils.formatPercent(errorRate);
        }

        // æ›´æ–°ä»»åŠ¡å®Œæˆè¶‹åŠ¿å›¾
        function updateTrendChart(data) {
            const chartData = chartUtils.formatHourlyData(data);
            charts.trend.data.labels = chartData.labels;
            charts.trend.data.datasets[0].data = chartData.completed;
            charts.trend.data.datasets[1].data = chartData.failed;
            charts.trend.update();
        }

        // æ›´æ–°ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒå›¾
        function updateStatusChart(data) {
            const statusData = data.performance_by_status || {};
            const completed = statusData.completed?.count || 0;
            const failed = statusData.failed?.count || 0;
            
            charts.status.data.datasets[0].data = [completed, failed, 0, 0];
            charts.status.update();
        }

        // æ›´æ–°å“åº”æ—¶é—´åˆ†å¸ƒå›¾
        function updateResponseTimeChart(data) {
            if (!data || data.length === 0) return;
            
            charts.responseTime.data.labels = data.map(item => item.bucket);
            charts.responseTime.data.datasets[0].data = data.map(item => item.count);
            charts.responseTime.update();
        }

        // æ›´æ–°é‡è¯•æˆåŠŸç‡å›¾
        function updateRetryChart(data) {
            if (!data || data.length === 0) return;
            
            const labels = data.map(item => `é‡è¯• ${item.retry_count} æ¬¡`);
            const successRates = data.map(item => item.success_rate);
            
            charts.retry.data.labels = labels;
            charts.retry.data.datasets[0].data = successRates;
            charts.retry.update();
        }

        // æ›´æ–°ç«¯ç‚¹æ€§èƒ½è¡¨æ ¼
        function updateEndpointPerformance(tasks) {
            const endpointStats = {};
            
            // ç»Ÿè®¡æ¯ä¸ªç«¯ç‚¹çš„æ€§èƒ½æ•°æ®
            tasks.forEach(task => {
                const endpoint = task.endpoint;
                if (!endpointStats[endpoint]) {
                    endpointStats[endpoint] = {
                        count: 0,
                        completed: 0,
                        totalDuration: 0,
                        maxDuration: 0
                    };
                }
                
                endpointStats[endpoint].count++;
                if (task.status === 'completed') {
                    endpointStats[endpoint].completed++;
                    if (task.duration) {
                        endpointStats[endpoint].totalDuration += task.duration;
                        endpointStats[endpoint].maxDuration = Math.max(
                            endpointStats[endpoint].maxDuration,
                            task.duration
                        );
                    }
                }
            });

            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const sortedEndpoints = Object.entries(endpointStats)
                .map(([endpoint, stats]) => ({
                    endpoint,
                    count: stats.count,
                    successRate: (stats.completed / stats.count * 100),
                    avgDuration: stats.completed > 0 ? (stats.totalDuration / stats.completed) : 0,
                    maxDuration: stats.maxDuration
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            // æ›´æ–°è¡¨æ ¼
            const tbody = document.getElementById('endpointTableBody');
            if (sortedEndpoints.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = sortedEndpoints.map(item => `
                <tr>
                    <td>${item.endpoint}</td>
                    <td>${utils.formatNumber(item.count)}</td>
                    <td>
                        <span class="${item.successRate >= 90 ? 'text-success' : item.successRate >= 70 ? 'text-warning' : 'text-danger'}">
                            ${utils.formatPercent(item.successRate)}
                        </span>
                    </td>
                    <td>${utils.formatDuration(item.avgDuration)}</td>
                    <td>${utils.formatDuration(item.maxDuration)}</td>
                </tr>
            `).join('');
        }

        // åº”ç”¨è‡ªå®šä¹‰æ—¶é—´èŒƒå›´
        function applyCustomRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¶é—´');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´');
                return;
            }
            
            loadStatistics();
        }

        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        function refreshStatistics() {
            loadStatistics();
        }

        // å¯¼å‡ºç»Ÿè®¡æŠ¥è¡¨
        async function exportStatistics() {
            try {
                const params = { hours: currentTimeRange, format: 'csv' };
                
                // å¦‚æœæ˜¯è‡ªå®šä¹‰æ—¶é—´èŒƒå›´
                const customRange = document.getElementById('customDateRange');
                if (customRange.style.display !== 'none') {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate && endDate) {
                        params.start_date = new Date(startDate).toISOString();
                        params.end_date = new Date(endDate).toISOString();
                        delete params.hours;
                    }
                }

                const blob = await api.exportStatisticsReport(params);
                const filename = `statistics_report_${new Date().toISOString().slice(0, 10)}.csv`;
                api.downloadFile(blob, filename);
            } catch (error) {
                console.error('Failed to export statistics:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
        });
    </script>
</body>
</html>